#include "structures/data/Trees.h"

#include "Random.h"
#include <array>

namespace
{
// clang-format off
std::array treeRows{
    2050, 4098, 2, 71682, 38914, 10242, 6146, 34818, 36866, 75778, 8194, 32770,
    43010, 26347526, 106963, 107043, 21084166, 104907, 21626886, 22679558,
    22155270, 40962, 14523, 25338335, 22675462, 26345478, 21117127, 21086214,
    25298950, 73730, 20035590, 109091, 109003, 16579, 104995, 106971, 109019,
    105003, 106955, 22714911, 26384863, 25860575, 22677510, 22714839, 25864735,
    25296902, 25300998, 25336351, 25340463, 25823238, 20068551, 12483, 14515,
    16563, 16571, 104987, 109099, 20037638, 20066495, 22194727, 20070599,
    20590783, 20590791, 21082118, 21630982, 21666271, 21670367, 21670439,
    51202, 55298, 53250, 20482
};

std::vector<std::vector<uint8_t>> treeTrunk{
    {48, 1, 6, 0, 9, 1, 1, 11, 19, 4, 31, 4, 7, 3, 12, 36},
    {39, 3, 20, 0, 6, 17, 34, 1, 42, 0, 49, 0, 0, 8, 0, 4, 13, 1, 4, 0, 13, 2},
    {6, 0, 17, 64, 4, 3, 14, 23, 2, 1, 0, 41, 66, 8, 0, 43, 24},
    {8, 32, 6, 14, 59, 67, 55, 11},
    {24, 1, 2, 2, 40, 1, 38, 4, 0, 2, 0, 37, 21, 21},
    {10, 3, 17, 7, 5, 15, 34, 35}, {36, 1, 1, 20, 9, 2},
    {7, 25, 1, 2, 8, 1, 8, 15}, {2, 29, 14, 65, 8, 28}, {10, 2, 15, 44},
    {1, 6, 13, 7}, {18, 32, 5, 20, 0}, {19, 4, 1, 5, 2}, {29, 3, 31},
    {5, 1, 7}, {10, 6, 13}, {10, 2, 1}, {10, 4, 0}, {7, 10}, {3, 1},
    {11, 2, 38}, {1, 25, 23}, {3, 2, 1}, {0}, {4}, {0, 0}, {45, 6}, {46, 5},
    {0}, {5, 12}, {5, 2}, {5, 3}, {0, 18}, {9, 0}, {5}, {2}, {4, 1}, {0}, {21},
    {3}, {7}, {7}, {1}, {12}, {1}, {5}, {2}, {}, {12}, {0}, {11}, {4}, {12},
    {4}, {11}, {0}, {}, {2}, {1}, {3}, {2}, {4}, {8}, {1}, {4}, {1}, {9}, {3},
    {16, 33, 57, 27, 63, 50, 58, 53, 33, 30, 27, 60, 26, 51, 16, 62, 54, 16, 22, 22, 61, 52, 30, 26, 22}
};

std::vector<std::vector<uint8_t>> treePenultimate{
    {4, 37, 56, 28, 3}, {2, 35, 3}, {2}, {47, 6}, {}, {2, 19}, {6}, {}, {3},
    {}, {18, 2}, {}, {}, {0}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {3}, {9}, {},
    {}, {}, {}, {}, {}, {}, {}, {}, {9}, {}, {}, {0}, {0}, {}, {}, {}, {}, {},
    {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {0}, {}, {}, {}, {}, {}, {},
    {}, {}, {}, {}, {}, {3}
};

std::array penultimateFallback{
    0, 0, 0, 0, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 6, 6, 9, 9, 18, 19, 28, 35, 37,
    47, 56
};

std::array treeTop{68, 68, 68, 68, 68, 69, 69, 69, 69, 70, 70, 70, 71};
// clang-format on
} // namespace

namespace Data
{

TileBuffer getTree(int height, Random &rnd)
{
    TileBuffer tree;
    tree.resize(3, height);
    int state = treeTrunk.size() - 1;
    for (int y = height - 1; y >= 0; --y) {
        if (y > 1) {
            state = rnd.select(treeTrunk[state]);
        } else if (y == 1) {
            if (treePenultimate[state].empty()) {
                state = rnd.select(penultimateFallback);
            } else {
                state = rnd.select(treePenultimate[state]);
            }
        } else {
            state = rnd.select(treeTop);
        }
        uint32_t rowData = treeRows[state];
        uint8_t mask = rowData & 0x7;
        rowData >>= 3;
        for (int x = tree.getWidth() - 1; x >= 0; --x) {
            Tile &tile = tree.getTile(x, y);
            tile.blockID = (mask & 1) == 1 ? TileID::tree : TileID::empty;
            mask >>= 1;
            tile.frameX = 22 * ((rowData >> 4) & 0xf);
            tile.frameY = 22 * (rowData & 0xf);
            rowData >>= 8;
        }
    }
    return tree;
}

} // namespace Data
